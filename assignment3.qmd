---
title: "Assignment 3: Profit Model"
author: "Tom Gibbens-Matsuyama, Haylee Oyler"
format: html
editor: visual
---

1. Develop a profit model for your almond yield

- Use your imagination to think about what would make sense
- Make sure you include parameters
- You could assume a baseline profit and then adjust according to the anomaly

2. Apply the profit model to your almond yield model

There are many ways to combine the almond yield and profit functions; you can have the profit function "call"/use the almond yield function; or create a wrapper function that calls them in sequence (first the almond yield and then the profit function)

Almonds:
- Corr: -0.71
- Slope: -1.04

Almond func:
- The entire almond yield for that year

Profit func:
- Compute profit given yearly almond yield (pa)

profit_almond <- compute_profit_fromyield(
  almond_yield = clean_monthly$almond_yield, # input
  year = clean_monthly$year, # input
  price = 30, # idk (parameter?)
  discount = 0.04 # parameter
)

3. Perform  a simple informal sensitivity analysis of almond yield profit using at least 2 parameters

4. Create 2 graphs
    - one that shows yield anomaly for each year, accounting for uncertainty in the parameters
    - one that show how yield anomaly in general varies with your parameters

5. Write a short paragraph (in a Quatro document) to summarize you interpretation of your model results (e.g what do 'take away' from your model and sensitivity analysis)

Submit as a group: a Quatro document, your R files for almond yield and profit model on Canvas- Due Date Monday April 21

### Load libraries

```{r}
library(tidyverse)
library(here)
library(janitor)
library(purrr)

source('R/compute_almond_yield.R')
source('R/compute_profit.R')
source('R/compute_NPV.R')
source('R/run_almond_profit_model.R')
```

### Load data

```{r}
climate <- read_table(here("data", "clim.txt")) %>% 
  clean_names()
```

### Apply the almond model

```{r}
profit_df <- run_almond_profit_model(data = climate, price=40)
```

From Ojas's email:

Just an update on the graphs, the intention was indeed to show almond profits and not yields. So it's up to you which one you would like to output. e.g. you can do it in the way we talked about in section:

- One graph with almond yields through time with parameter uncertainty in yields
- One graph with almond profits parameter uncertainty in profits (this is could be a combo of uncertainty in yield and profit parameters, or any one of the two, as long as it's at least two parameters). This could be overall for all years combined, or again through time.

You could also do it in another way:
- One graph with almond yields in any one year or for all years together, with uncertainty
- One graph with profits over time with uncertainty

Finally, you could also have both graphs with profits, overall uncertainty and through time. But it might be informative to see the yield results separately.

Feel free to pick and be creative if you feel like it, i'll accept all combinations, just please explain what you've done etc. as mentioned in the assignment.
```{r}
# Plot profit over time with discounting
ggplot(profit_df, aes(x = year, y = netpresent_profit)) +
  # geom_boxplot() +
  geom_line(color = "darkgreen") +
  geom_point(color = "black") +
  labs(
    title = "Discounted Almond Profit Over Time",
    x = "Year",
    y = "Discounted Profit ($/acre)"
  ) +
  theme_minimal()
```

Boxplot doesn't work because we only have on observation per year... 
```{r}
profit_without_1995 <-  
  profit_df %>% 
  filter(year != 1995)

ggplot(profit_without_1995, aes(as.factor(year), 
                                netpresent_profit, 
                                group = year)) +
geom_boxplot() +
labs(y = "Net Present Value of Power in 1945 Dollars", 
     x = "Year")

```

## Sensitivity Analysis

```{r}
# lets try sensitivity analysis again,
# ethresh - is defaulted to 10000; lets try +- 15%
# lets try 40 samples
# assume a uniform distribution - we don't know anything about variation
# TRYING FOR PRICE FIRST
deviation <- 1500
base_thresh <- 4000
price <- runif(
  min = base_thresh - deviation * base_thresh,
  max = base_thresh + deviation * base_thresh, n = 40
)

# now run our model for the parameters
site2 <- price %>% map(~ run_almond_profit_model(
  data = climate,
  price = .x
))
```

```{r}

# extract a useful data structure,lets say we want just the annual data (not the mean), and then reformat as a data frame with nice column names
tmp <- map_df(site2, `[`, c("annual"))
site2df <- data.frame(
  year = tmp$annual$year,
  elect = tmp$annual$elect
)

# now we could plot
ggplot(
  site2df,
  aes(as.factor(year), elect, group = year)
) +
  geom_boxplot() +
  labs(y = "Electricity generated in W", x = "Year")
```

```{r}
# Sensitivtiy analysis for price assuming 15% deviation
deviation <- 0.15
base_price <- 4000  
n_samples <- 40

# Assuming uniform distribution, could change to normal...
prices <- runif(n_samples,
                min = base_price * (1 - deviation),
                max = base_price * (1 + deviation))

```


```{r}
# Map the distribution of prices onto our almond profit model
profit_runs <- map(prices, function(p) {
  run_almond_profit_model(climate, price = p) %>%
    mutate(sampled_price = p)  # track which price this run used
})

profit_df_all <- bind_rows(profit_runs)

```

```{r}
# Visualize the results 
profit_df_all %>% 
  filter(year != 1995) %>% # Removed outlier 
  ggplot(aes(x = factor(year), 
                          y = netpresent_profit, group = year)) +
  geom_boxplot(fill = "lightblue", color = "steelblue") +
  labs(
    title = "Sensitivity of Almond Profit to Market Price",
    x = "Year",
    y = "Discounted Profit ($/acre)"
  ) +
  theme_minimal()

```
The boxplot represents how the uncertainty in the price for each year affects the overall profit from almond yields. 

For the other parameter, we could change the discounting rate? We could also vary one of the betas. 

```{r}
# Sensitivtiy analysis for price assuming 15% deviation
deviation <- 0.15
base_price <- 4000  
n_samples <- 300

# Assuming uniform distribution, could change to normal...
price <- runif(n_samples,
                min = base_price * (1 - deviation),
                max = base_price * (1 + deviation))

discount <- rnorm(mean = 0.12, sd = 0.1, n = n_samples)

# put samples together
parms <- cbind.data.frame(price, discount)

# use pmap
# takes function name and then names of all parameters that don't change
results <- parms %>% pmap(run_almond_profit_model,
  data = climate, 
)
```

```{r}
# now we can extract results from the list as above
mean_profit <- map_df(results, `[`, c("netpresent_profit"))
```

```{r}
# and we can add the parameter values for each run
mean_profit <- cbind.data.frame(mean_profit, parms)

# plot - pick one of the 2 parameter as a color
# try switching which parameter used for color

p1 <- ggplot(mean_profit, aes(price, mean_profit, col = discount)) +
  geom_point(cex = 2) +
  labs(y = "Mean Annual Electricity W", x = "Threshold Radiation (kJ/m2)  \n above which energy production is more efficient")
p1

```

```{r}
# Set base values and deviation
deviation <- 0.15
base_price <- 4000
base_discount <- 0.12
n_samples <- 40

# Sample from uniform distributions
param_grid <- tibble(
  price = runif(n_samples, base_price * (1 - deviation), base_price * (1 + deviation)),
  discount = runif(n_samples, base_discount * (1 - deviation), base_discount * (1 + deviation))
)

```

```{r}
profit_runs <- pmap(param_grid, function(price, discount) {
  run_almond_profit_model(climate, price = price, discount = discount) %>%
    mutate(price = price, discount = discount)
})

profit_df_all <- bind_rows(profit_runs)

```

```{r}
ggplot(profit_df_all, aes(x = factor(year), 
                          y = netpresent_profit, group = year)) +
  geom_boxplot(fill = "lightgreen", color = "forestgreen") +
  labs(
    title = "Profit Distribution by Year with Varying Price and Discount Rate",
    x = "Year", y = "Discounted Profit ($/acre)"
  ) +
  theme_minimal()

```

